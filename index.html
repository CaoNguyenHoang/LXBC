<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
<title>LXBC - Lưu Xá Bosco</title>

<link rel="icon" href="image/logoden.jpg" type="image/jpeg">
<link rel="shortcut icon" href="image/logoden.jpg" type="image/jpeg">
<link rel="apple-touch-icon" href="image/logoden.jpg">

<meta name="description" content="Trang web tĩnh: banner, thành viên, hoạt động. Theme vàng–đen." />
<meta name="theme-color" content="#0b0b0b" />

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800&display=swap&subset=vietnamese" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer></script>

<style>
/* ===== VARIABLES & RESET ===== */
:root {
  --bg: #0b0b0b; --card: #121315; --text: #f5f5f5; --muted: #9ca3af; --border: #27272a;
  --brand: #ffc800; --brand-hover: #ffd633;
  --safe-top: env(safe-area-inset-top);
  --font-ui: 'Be Vietnam Pro', sans-serif;
  --radius: 12px;
  --header-height: 60px;
}
*,*::before,*::after { box-sizing: border-box; }
html { scroll-behavior: smooth; }
body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: var(--font-ui); line-height: 1.5; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
a { color: inherit; text-decoration: none; }
img { max-width: 100%; display: block; }

/* ===== LAYOUT & ADS ===== */
.site-wrapper { display: flex; justify-content: center; align-items: flex-start; width: 100%; }
.main-content { width: 100%; max-width: 1200px; background: var(--bg); min-height: 100vh; position: relative; z-index: 1; }

.ad-side { width: 160px; height: 600px; position: sticky; top: calc(var(--header-height) + 20px); display: none; margin: 0 10px; flex-shrink: 0; border-radius: 8px; overflow: hidden; background: #111; border: 1px solid #333; transition: all 0.3s; }
.ad-link { display: block; width: 100%; height: 100%; position: relative; text-decoration: none; }
.ad-side img { width: 100%; height: 100%; object-fit: cover; opacity: 0.25; filter: grayscale(100%); transition: all 0.5s ease; }
.ad-text { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; text-align: center; color: rgba(255,255,255,0.5); font-size: 0.85rem; font-weight: 600; padding: 10px; pointer-events: none; text-transform: uppercase; letter-spacing: 1px; z-index: 2; text-shadow: 0 2px 4px rgba(0,0,0,0.8); transition: opacity 0.3s; }
.ad-side.loaded img { opacity: 1 !important; filter: grayscale(0%) !important; }
.ad-side.loaded .ad-text { display: none !important; opacity: 0; }
.ad-side:not(.loaded):hover img { opacity: 0.5; filter: grayscale(0); }
.ad-side:not(.loaded):hover .ad-text { color: var(--brand); }
.ad-side.loaded:hover { border-color: var(--brand); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255, 200, 0, 0.1); }
@media (min-width: 1450px) { .ad-side { display: block; } }

.container { max-width: 1200px; margin: 0 auto; padding: 0 16px; }

/* ===== UI COMPONENTS ===== */
.nav { position: sticky; top: 0; z-index: 1000; background: rgba(11,11,11,.95); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border-bottom: 1px solid var(--border); width: 100%; }
.nav-inner { display: flex; align-items: center; justify-content: space-between; height: var(--header-height); }
.brand { display: flex; align-items: center; gap: 8px; font-weight: 800; font-size: 1.15rem; letter-spacing: -0.5px; }
.brand-logo { width: 32px; height: 32px; border-radius: 8px; border: 1px solid #333; }
.nav-links { display: flex; gap: 8px; }

.chip { padding: 6px 16px; border-radius: 99px; font-size: 0.85rem; font-weight: 600; background: rgba(255,255,255,0.08); color: #ccc; cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
.chip:hover { background: var(--brand); color: #000; border-color: var(--brand); }

.section { padding: 48px 0; border-bottom: 1px solid var(--border); }
#gioi-thieu { padding-top: 30px; padding-bottom: 40px; }
.section h2 { font-size: clamp(24px, 4vw, 36px); margin: 0 0 20px; font-weight: 800; letter-spacing: -1px; }

.motto-frame { display: inline-block; padding: 8px 24px; margin-bottom: 24px; position: relative; overflow: hidden; background: linear-gradient(180deg, rgba(30, 30, 30, 0.8), rgba(10, 10, 10, 0.9)); border: 1px solid rgba(255, 200, 0, 0.5); border-radius: 99px; box-shadow: inset 0 0 15px rgba(0,0,0,1), 0 4px 10px rgba(0,0,0,0.5); color: var(--brand); font-weight: 800; text-transform: uppercase; letter-spacing: 1.5px; font-size: clamp(0.85rem, 3vw, 1.1rem); text-shadow: 0 2px 10px rgba(255, 200, 0, 0.2); }
.motto-frame::after { content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%; opacity: 0; transform: skewX(-20deg); background: linear-gradient(to right, rgba(255, 200, 0, 0) 0%, rgba(255, 200, 0, 0.1) 30%, rgba(255, 230, 100, 0.6) 50%, rgba(255, 200, 0, 0.1) 70%, rgba(255, 200, 0, 0) 100%); animation: goldSheen 12s ease-in-out infinite; }
@keyframes goldSheen { 0% { left: -100%; opacity: 0; } 5% { opacity: 1; } 20% { left: 200%; opacity: 0; } 100% { left: 200%; opacity: 0; } }

.btn-more, .intro-readmore, .btn { display: inline-flex; align-items: center; justify-content: center; padding: 10px 28px; border-radius: 99px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.15); color: var(--brand); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); font-size: 0.85rem; text-decoration: none; }
.btn-more:hover, .intro-readmore:hover, .btn:hover { background: var(--brand); border-color: var(--brand); color: #000; transform: translateY(-2px); box-shadow: 0 4px 15px rgba(255, 200, 0, 0.25); }
.btn-more:active, .intro-readmore:active, .btn:active { transform: scale(0.96); }

.intro-text { margin: 0 auto; color: #d1d5db; max-width: 700px; font-size: 1rem; line-height: 1.7; text-align: justify; text-indent: 2em; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; }
.intro-text.expanded { -webkit-line-clamp: unset; }
.intro-readmore { margin-top: 24px; } 

.filter-row { display: flex; align-items: center; gap: 10px; margin-bottom: 24px; height: 44px; }
.search-wrap { position: relative; width: 44px; height: 44px; z-index: 90; transition: width 0.3s cubic-bezier(0.16, 1, 0.3, 1); flex-shrink: 0; }
.search-trigger { position: absolute; inset: 0; border-radius: 99px; background: #202023; border: 1px solid var(--border); color: var(--muted); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
.search-trigger:hover { color: var(--brand); border-color: var(--brand); }
.search-input { position: absolute; inset: 0; width: 100%; height: 100%; background: transparent; border: none; color: transparent; padding: 0; pointer-events: none; opacity: 0; border-radius: 99px; font-family: inherit; transition: 0.2s; }
.search-wrap.open { width: 100%; max-width: 300px; }
.search-wrap.open .search-trigger { opacity: 0; pointer-events: none; transform: scale(0.8); }
.search-wrap.open .search-input { background: #18181b; border: 1px solid var(--brand); color: #fff; padding: 0 16px; opacity: 1; pointer-events: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }

.quick-filters { display: flex; gap: 8px; overflow-x: auto; flex: 1; scrollbar-width: none; padding-right: 16px; align-items: center; -webkit-overflow-scrolling: touch; }
.quick-filters::-webkit-scrollbar { display: none; }
.q-btn { white-space: nowrap; padding: 0 16px; height: 44px; border-radius: 99px; border: 1px solid var(--border); background: #17191b; color: #9ca3af; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: 0.2s; }
.q-btn:hover { background: #222; color: #fff; }
.q-btn.active { background: rgba(255,200,0,0.1); border-color: var(--brand); color: var(--brand); }

/* ===== MEMBERS GRID ===== */
.team-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
@media (min-width: 600px) { .team-grid { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; } }
@media (min-width: 1024px) { .team-grid { grid-template-columns: repeat(5, 1fr) !important; } }
.hidden-item { display: none !important; }

.member-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; position: relative; cursor: pointer; transform: translateZ(0); backface-visibility: hidden; will-change: transform; transition: transform 0.2s, box-shadow 0.2s; }
.member-card:hover { transform: translateY(-4px); box-shadow: 0 10px 25px rgba(0,0,0,0.3); border-color: #444; }

.btn-qr { position: absolute; top: 6px; right: 6px; z-index: 10; width: 34px; height: 34px; border-radius: 50%; background: rgba(0, 0, 0, 0.25); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); border: 1px solid rgba(255, 200, 0, 0.3); display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.3); transition: 0.3s ease; }
.btn-qr:hover { transform: scale(1.1); background: rgba(255, 200, 0, 0.2); border-color: var(--brand); box-shadow: 0 0 15px rgba(255, 200, 0, 0.4); }
.btn-qr svg { width: 18px; height: 18px; color: var(--brand); }

@keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
.member-photo { aspect-ratio: 3/4; overflow: hidden; background: #1a1a1a; background: linear-gradient(90deg, #1a1a1a 25%, #222 50%, #1a1a1a 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
.member-photo img { width: 100%; height: 100%; object-fit: cover; transition: opacity 0.3s; }
.member-info { padding: 8px 4px; text-align: center; position: absolute; bottom: 0; inset-inline: 0; background: linear-gradient(to top, rgba(0,0,0,0.95) 20%, transparent); }
.m-name { font-weight: 700; font-size: 0.8rem; color: #fff; margin-bottom: 2px; text-shadow: 0 2px 4px rgba(0,0,0,0.8); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.m-role { font-size: 0.65rem; color: var(--brand); font-weight: 600; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
@media (min-width: 600px) { .member-info { padding: 12px 8px; } .m-name { font-size: 0.95rem; } .m-role { font-size: 0.8rem; } }

/* ===== ACTIVITY CARD ===== */
#actGrid { display: grid; gap: 20px; grid-template-columns: 1fr; }
@media (min-width: 600px) { #actGrid { grid-template-columns: repeat(2, 1fr); } }
@media (min-width: 1024px) { #actGrid { grid-template-columns: repeat(3, 1fr); } }

.act-card { height: 250px; border-radius: 16px; position: relative; overflow: hidden; border: 1px solid var(--border); background: #000; transform: translateZ(0); backface-visibility: hidden; will-change: transform; transition: transform 0.3s; }
.act-card:hover { transform: translateY(-4px); border-color: #555; }
.act-bg { position: absolute; inset: 0; z-index: 0; background: #1a1a1a; }
.act-bg img { width: 100%; height: 100%; object-fit: cover; opacity: 0.7; filter: brightness(0.8); transition: transform 0.6s; }
.act-card:hover .act-bg img { transform: scale(1.05); }
.act-content { position: absolute; inset: 0; z-index: 2; padding: 16px; display: flex; flex-direction: column; justify-content: flex-end; background: linear-gradient(to bottom, transparent 30%, rgba(0,0,0,0.95) 100%); }
.ribbon { position: absolute; top: 12px; right: -32px; transform: rotate(45deg); background: var(--brand); color: #000; font-size: 0.65rem; font-weight: 800; padding: 4px 34px; z-index: 10; text-transform: uppercase; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
.act-title { font-size: 1.15rem; font-weight: 800; margin: 0 0 6px; line-height: 1.3; color: #fff; }
.act-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
.act-chip { font-size: 0.7rem; padding: 3px 8px; border-radius: 6px; background: rgba(255,255,255,0.15); backdrop-filter: blur(4px); color: #eee; font-weight: 600; }
.act-sum { font-size: 0.85rem; color: #d1d5db; line-height: 1.4; margin-bottom: 12px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

.act-btn { align-self: flex-start; background: var(--brand); color: #000; padding: 8px 20px; border-radius: 99px; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; transition: 0.2s; border: none; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; }
.act-btn:hover { background: #fff; color: #000; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(255, 200, 0, 0.4); }

/* Modals */
.modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 16px; opacity: 0; transition: opacity 0.2s; pointer-events: none; }
.modal.open { display: flex; opacity: 1; pointer-events: auto; }
.modal-box { background: #111; border: 1px solid #333; width: 100%; max-width: 420px; border-radius: 20px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.8); display: flex; flex-direction: column; max-height: 90vh; transform: scale(0.95); transition: transform 0.2s cubic-bezier(0.16, 1, 0.3, 1); }
.modal.open .modal-box { transform: scale(1); }
.modal-header { padding: 14px 20px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; background: #161616; }
.modal-title { font-weight: 700; font-size: 1.05rem; }
.close-btn { background: none; border: none; color: #888; font-size: 1.5rem; cursor: pointer; padding: 0 4px; transition: color 0.2s; }
.close-btn:hover { color: #fff; }
.modal-content { padding: 24px; overflow-y: auto; }
.m-detail-grid { display: flex; flex-direction: column; align-items: center; gap: 20px; }

/* --- PASSWORD MODAL STYLES --- */
.pass-input-wrap { margin-top: 10px; position: relative; }
.pass-input { width: 100%; padding: 12px 16px; background: #222; border: 1px solid #444; color: #fff; border-radius: 12px; font-size: 1rem; outline: none; transition: 0.2s; font-family: inherit; }
.pass-input:focus { border-color: var(--brand); box-shadow: 0 0 0 2px rgba(255,200,0,0.15); background: #18181b; }
.pass-input.error { border-color: #ff4444; box-shadow: 0 0 0 2px rgba(255, 68, 68, 0.15); animation: shake 0.4s ease; }
.pass-err-msg { color: #ff4444; font-size: 0.85rem; margin-top: 8px; display: none; align-items: center; gap: 6px; }
.pass-actions { display: flex; gap: 12px; margin-top: 24px; justify-content: flex-end; }
.btn-action { padding: 10px 24px; border-radius: 8px; font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: 0.2s; border: none; }
.btn-cancel { background: transparent; border: 1px solid #333; color: #999; }
.btn-cancel:hover { border-color: #666; color: #fff; }
.btn-confirm { background: var(--brand); color: #000; font-weight: 700; }
.btn-confirm:hover { background: #fff; box-shadow: 0 4px 12px rgba(255,200,0,0.3); }
@keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }

/* --- GALLERY & ANIMATIONS (UPDATED) --- */
.m-gallery-container { width: 140px; height: 140px; border-radius: 50%; position: relative; overflow: hidden; box-shadow: 0 8px 30px rgba(0,0,0,0.5); border: 4px solid #222; margin: 0 auto; cursor: zoom-in; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); user-select: none; }
.m-gallery-container.is-expanded { width: 100%; max-width: 320px; height: auto; aspect-ratio: 1/1; border-radius: 20px; cursor: zoom-out; border: 4px solid transparent; background: linear-gradient(#000, #000) padding-box, linear-gradient(45deg, var(--brand), #222, var(--brand), #222) border-box; background-size: 300% 300%; animation: borderFlow 3s ease infinite; box-shadow: 0 25px 60px rgba(0,0,0,0.9); }
@keyframes borderFlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
.m-gallery-img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }

/* STYLE NÚT ĐIỀU HƯỚNG ẢNH MỚI (KHÔNG VIỀN, NHỎ HƠN) */
.gal-nav { 
  display: none; 
  position: absolute; 
  bottom: 15px; 
  right: 15px; 
  z-index: 20; 
  
  /* Không viền, nền mờ */
  background: rgba(0, 0, 0, 0.2); 
  backdrop-filter: blur(4px); 
  -webkit-backdrop-filter: blur(4px); 
  border: none; /* Tắt viền */
  
  color: var(--brand); 
  font-weight: 800; 
  font-size: 0.75rem; /* Nhỏ hơn */
  letter-spacing: -1px; 
  line-height: 1; 
  padding: 8px 12px; /* Gọn hơn */
  border-radius: 99px; 
  cursor: pointer; 
  user-select: none; 
  transition: all 0.3s ease; 
}

/* Chỉ hiện khi expanded VÀ có nhiều ảnh (class has-multiple) */
.m-gallery-container.is-expanded.has-multiple .gal-nav { 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  animation: fadeInNav 0.5s ease 0.3s forwards; 
  opacity: 0; 
}

@keyframes fadeInNav { to { opacity: 1; } }

.gal-nav:hover { 
  background: rgba(255, 200, 0, 0.15); 
  transform: scale(1.05); 
}

.m-info-list { width: 100%; text-align: center; }
.info-row { margin-bottom: 8px; font-size: 0.95rem; }
.info-lbl { color: #888; font-size: 0.85rem; font-weight: 500; margin-right: 6px; }
.info-lbl::after { content: ":"; }
.info-val { color: #fff; font-weight: 600; }
.contact-actions { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 24px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
.c-btn { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px; border-radius: 12px; font-weight: 600; font-size: 0.9rem; background: #222; color: #fff; transition: 0.2s; border: 1px solid rgba(255,255,255,0.05); }
.c-btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
.c-btn.facebook { background: #1877F2; }
.c-btn.zalo { background: #0068FF; }
.c-btn.phone { background: #34A853; }
.c-btn.email { background: #EA4335; }
.c-btn.instagram { background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); border: none; }
.c-btn.locket { background: #FFAD1F; color: #000; }
.c-btn.join-ctv { background: var(--brand); color: #000; font-weight: 800; border: 1px solid var(--brand); box-shadow: 0 4px 15px rgba(255, 200, 0, 0.3); grid-column: span 2; }
.c-btn.join-ctv:hover { background: #fff; box-shadow: 0 4px 20px rgba(255, 200, 0, 0.5); }
.m-note { margin-top: 12px; color: var(--brand); font-style: italic; font-size: 0.9rem; font-weight: 500; line-height: 1.4; padding: 4px 12px; border-radius: 6px; background: rgba(255, 200, 0, 0.1); display: inline-block; }

/* Hero Slider */
#banner-wrapper { padding: 20px 16px 0 16px; background: #000; }
.hero-slider { position: relative; width: 100%; max-width: 1100px; margin: 0 auto; overflow: hidden; background: #000; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); aspect-ratio: 4 / 3; }
.slide { position: absolute; inset: 0; opacity: 0; transition: opacity 1.2s ease, transform 1.5s ease; transform: scale(1.08); z-index: 1; }
.slide.active { opacity: 1; transform: scale(1); z-index: 2; }
.slide img { width: 100%; height: 100%; object-fit: cover; object-position: center top; }
.dots { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; z-index: 10; padding: 8px 12px; background: rgba(0,0,0,0.3); border-radius: 20px; backdrop-filter: blur(4px); }
.dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(255,255,255,0.4); cursor: pointer; transition: 0.3s; }
.dot.active { background: var(--brand); transform: scale(1.4); }

.more-container { display: flex; justify-content: center; margin-top: 24px; }
.dropzone { display: flex; gap: 10px; margin-bottom: 20px; padding: 20px; border: 1px dashed #444; border-radius: 16px; justify-content: center; background: #111; }
footer { border-top: 1px solid var(--border); background: #050505; }
.contact-info p { margin-bottom: 12px; font-size: 0.95rem; color: #ccc; }
.contact-info strong { color: var(--brand); }
</style>
</head>
<body>

<div class="site-wrapper">
  <aside class="ad-side left">
    <a href="https://mobile.mbbank.com.vn/referral/index.html" target="_blank" class="ad-link">
      <img src="image/mbbank.jpg" alt="MB Bank" 
           onload="this.closest('.ad-side').classList.add('loaded')"
           onerror="this.src='https://via.placeholder.com/160x600/0033cc/fff?text=MB+BANK'">
      <div class="ad-text">Mở thẻ<br>MB Bank<br>Ưu đãi HOT</div>
    </a>
  </aside>

  <main class="main-content">
    <nav class="nav">
      <div class="container nav-inner">
        <a href="#" class="brand">
          <img src="image/logo.jpg" class="brand-logo" alt="Logo" onerror="this.src='https://via.placeholder.com/40/333/fff?text=L'">
          <span>Lưu Xá <span style="color:var(--brand)">Bosco</span></span>
        </a>
        <div class="nav-links">
          <a href="https://www.facebook.com/SinhVienDonboscoSOB" target="_blank" class="chip">SOB</a>
          <button id="btnOpenContact" class="chip">Liên hệ</button>
        </div>
      </div>
    </nav>

    <section id="banner-wrapper">
      <div class="hero-slider">
        <div class="slide active"><img src="image/banner1.jpg" alt="Banner 1" fetchpriority="high" loading="eager"></div>
        <div class="slide"><img src="image/banner2.jpg" alt="Banner 2" loading="lazy"></div>
        <div class="slide"><img src="image/banner3.jpg" alt="Banner 3" loading="lazy"></div>
        <div class="dots" id="dots"></div>
      </div>
    </section>

    <section id="gioi-thieu" class="section">
      <div class="container" style="text-align:center">
        <div class="motto-frame">Chân Tình • Hết Mình</div>
        <div class="intro-text" id="introContent">
          Lưu xá Bosco là nhà lưu xá nam mới được thành lập vào năm học 2017-2018 dưới sự dìu dắt của Linh mục Đa Minh Lã Minh Cường,  Cha Phanxico Xavie Trần Quốc Tuấn, và hiện tại Cha Phaolo Nguyễn Toàn Khoa tiếp quản chăm sóc đồng hành cùng với 4 cô cộng tác viên là: má Hà, má Thủy, má Linh và má Hoa.
Hiện nay tọa lạc tại 161 Bùi Thị Xuân, Phường Xuân Hương Tp Đà Lạt, nhà lưu xá có khoảng 13 anh em sống yêu thương, đùm bọc, giúp đỡ lẫn nhau trong học tập và đời sống hằng ngày.
Trải qua 8 năm với các đời trưởng nhà Lu-i Lại Phi Hùng, Phê-rô Nguyễn Văn Sinh, Đaminh Hà Đăng Dũng, Giuse Vũ Hoàng Bảo Khôi, Gioan Baotixita Trần Thiên, Toma Lê Vĩnh Thành, Giuse Hoàng Minh Trường, GiuseRô Đa Ka Hiệp Luca Tpuh Cao Trưởng và hiện tại là Phanxico Xavie Vũ Tấn Lực.
        </div>
        <button id="btnIntroMore" class="intro-readmore">Xem thêm</button>
      </div>
    </section>

    <section id="thanh-vien" class="section">
      <div class="container">
        <h2>Thành viên</h2>
        <div class="dropzone" id="drop" style="display:flex">
          <input id="excelFile" type="file" accept=".xlsx,.xls,.csv" class="btn" style="padding:6px" />
          <button class="btn" id="btnLoad">Tải Dữ Liệu (Fix PC)</button>
        </div>
        <div class="filter-row">
          <div class="search-wrap" id="searchWrap">
            <div class="search-trigger" id="searchTrigger"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></div>
            <input type="text" id="searchInput" class="search-input" placeholder="Nhập tên thành viên..." autocomplete="off">
          </div>
          <div class="quick-filters">
            <button class="q-btn" onclick="setMode('bdh')" id="btnQ_BDH">Điều Hành Nhà</button>
            <button class="q-btn" onclick="setMode('cuu')" id="btnQ_Cuu">Cựu Thành Viên</button>
            <button class="q-btn" onclick="setMode('ctv')" id="btnQ_CTV" style="display:none">Cộng Tác Viên</button>
            <button class="q-btn" onclick="setMode('pet')" id="btnQ_Pet">Pet</button>
            <button class="q-btn" onclick="setMode('tt')" id="btnQ_TT" style="display:none">Thành Viên Thường trực</button>
            <button class="q-btn" id="btnOrg">Sơ Đồ</button>
          </div>
        </div>
        
        <div id="all-members-grid" class="team-grid"></div>
        <div class="more-container"><button class="btn-more" id="btnMore" style="display:none">Xem thêm</button></div>
      </div>
    </section>

    <section id="hoat-dong" class="section">
      <div class="container">
        <h2>Hoạt động</h2>
        <div class="filter-row">
          <div class="search-wrap" id="actSearchWrap">
            <div class="search-trigger" id="actSearchTrigger"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></div>
            <input type="text" id="actSearchInput" class="search-input" placeholder="Tìm hoạt động..." autocomplete="off">
          </div>
          <div class="quick-filters" id="actFilters"></div>
        </div>
        <div id="actGrid"></div>
        <div class="more-container"><button class="btn-more" id="btnActMore">Xem thêm</button></div>
      </div>
    </section>

    <footer>
      <div class="container" style="padding:40px 0;text-align:center;color:#555;font-size:0.85rem">
        © <span id="year"></span> WEB LXBC-DEVELOPPED BY NGUYEN HOANG.
      </div>
    </footer>
  </main>

  <aside class="ad-side right">
    <a href="https://app.gostream.co" target="_blank" class="ad-link">
      <img src="image/gostream.jpg" alt="GoStream" 
           onload="this.closest('.ad-side').classList.add('loaded')"
           onerror="this.src='https://via.placeholder.com/160x600/ff6600/fff?text=GoStream'">
      <div class="ad-text">Phần mềm<br>Livestream<br>GoStream</div>
    </a>
  </aside>

</div>

<div id="modal" class="modal">
  <div class="modal-box">
    <div class="modal-header"><div class="modal-title">Hồ sơ thành viên</div><button class="close-btn" onclick="closeModal('modal')">×</button></div>
    <div class="modal-content">
      <div class="m-detail-grid">
        
        <div class="m-gallery-container" id="gal-wrap" onclick="toggleGallery(event)">
          <img id="m-avatar" class="m-gallery-img" src="image/logo.jpg" alt="Avatar">
          <div class="gal-nav next" onclick="galNext(event)">&gt;&gt;&gt;</div>
        </div>

        <div id="m-note-container" style="text-align:center"></div>

        <div class="m-info-list">
          <div class="info-row"><span class="info-lbl">Tên thánh</span> <span class="info-val" id="m-holy"></span></div>
          <div class="info-row"><span class="info-lbl">Họ tên</span> <span class="info-val" id="m-name"></span></div>
          <div class="info-row"><span class="info-lbl">Chức vụ</span> <span class="info-val" id="m-role"></span></div>
          <div class="info-row"><span class="info-lbl">Năm sinh</span> <span class="info-val" id="m-birth"></span></div>
          <div class="info-row"><span class="info-lbl">Ngành học</span> <span class="info-val" id="m-major"></span></div>
          <div class="info-row"><span class="info-lbl">Trường học</span> <span class="info-val" id="m-school"></span></div>
          <div class="info-row"><span class="info-lbl">Gia nhập</span> <span class="info-val" id="m-join"></span></div>
          <div id="m-bio" style="margin-top:16px;color:#999;font-size:0.9rem;line-height:1.6;font-style:italic"></div>
          <div id="m-contact-btns" class="contact-actions"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="passModal" class="modal">
  <div class="modal-box" style="max-width: 360px;">
    <div class="modal-header">
      <div class="modal-title">Yêu cầu quyền truy cập</div>
      <button class="close-btn" onclick="closeModal('passModal')">×</button>
    </div>
    <div class="modal-content">
      <p style="color:#ccc; font-size:0.9rem; margin-bottom:12px;">Nạp VIP cho Thái để lấy mật khẩu.</p>
      <div class="pass-input-wrap">
        <input type="password" id="userPassInput" class="pass-input" placeholder="Nhập mật khẩu...">
        <div id="passError" class="pass-err-msg">
          <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          Mật khẩu không đúng!
        </div>
      </div>
      <div class="pass-actions">
        <button class="btn-action btn-cancel" onclick="closeModal('passModal')">Hủy</button>
        <button class="btn-action btn-confirm" onclick="confirmPass()">Xác nhận</button>
      </div>
    </div>
  </div>
</div>

<div id="qrModal" class="modal">
  <div class="modal-box" style="max-width:320px">
    <div class="modal-header"><div class="modal-title">Tài Khoản Nhà LXBC</div><button class="close-btn" onclick="closeModal('qrModal')">×</button></div>
    <div class="modal-content" style="text-align:center">
      <img src="image/qr.jpg" alt="QR Code" style="width:100%;border-radius:12px;margin-bottom:12px;border:1px solid #333">
      <p style="color:#888;font-size:0.9rem">Nạp VIP cho Thái<br>hoặc nhịn đói</p>
    </div>
  </div>
</div>

<div id="orgModal" class="modal">
  <div class="modal-box" style="max-width:800px">
    <div class="modal-header"><div class="modal-title">Sơ đồ các thế hệ</div><button class="close-btn" onclick="closeModal('orgModal')">×</button></div>
    <div class="modal-content" id="orgBody"></div>
  </div>
</div>

<div id="contactModal" class="modal">
  <div class="modal-box">
    <div class="modal-header"><div class="modal-title">Thông tin liên hệ</div><button class="close-btn" onclick="closeModal('contactModal')">×</button></div>
    <div class="modal-content contact-info">
      <p><strong>Cha Đặc Trách:</strong> Phaolo Nguyễn Toàn Khoa</p>
      <p><strong>Điện thoại:</strong> <a href="tel:0909831284" >0909 831 284</a></p>
      <hr style="border-color:#333;margin:16px 0">
      <p><strong>Trưởng nhà:</strong> <span id="c-leader-name">Đang cập nhật...</span></p>
      <p><strong>Điện thoại:</strong> <a id="c-leader-phone" href="#">—</a></p>
      <hr style="border-color:#333;margin:16px 0">
      <p><strong>Địa chỉ:</strong> Số 161, Bùi Thị Xuân, Phường 2, TP. Đà Lạt.</p>
    </div>
  </div>
</div>

<script>
const $ = document.querySelector.bind(document);
const $$ = document.querySelectorAll.bind(document);
const rmAccent = (s) => String(s||'').normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();

const FOLDER_MEM = 'anh_thanh_vien';
const FOLDER_ACT = 'anh_hoat_dong';
const DEFAULT_AVATAR = 'image/logo.jpg';

function debounce(func, timeout = 200){
  let timer;
  return (...args) => {
    clearTimeout(timer);
    timer = setTimeout(() => { func.apply(this, args); }, timeout);
  };
}

const normalizeImg = (u, folder) => {
  u = String(u || '').trim();
  if (!u) return '';
  if (u.match(/^(http|https|data):/i)) {
    if(u.includes('drive.google.com')) {
      const m = u.match(/\/d\/([^/]+)/);
      return m ? `https://drive.google.com/uc?export=view&id=${m[1]}` : u;
    }
    return u;
  }
  u = u.replace(/\\/g, '/');
  const prefix = folder + '/';
  if (u.toLowerCase().startsWith(prefix.toLowerCase())) u = u.substring(prefix.length);
  if (u.startsWith('/')) u = u.substring(1);
  let fullPath = folder ? `${folder}/${u}` : u;
  return encodeURI(fullPath);
};

let MEMBERS = [], ACTS = [];
let showAllMem = false, activeFilterMode = 'default';
let activeActTag = null, showAllActs = false;

// --- GALLERY VARIABLES ---
let galImages = [];
let galIndex = 0;

$('#btnIntroMore').onclick = () => {
  const c = $('#introContent');
  const b = $('#btnIntroMore');
  c.classList.toggle('expanded');
  b.textContent = c.classList.contains('expanded') ? 'Thu gọn' : 'Xem thêm';
};

const setupSearch = (wrapId, inpId, trigId, callback) => {
  const wrap = $(wrapId), inp = $(inpId), trig = $(trigId);
  if(!wrap) return;
  trig.onclick = (e) => { e.stopPropagation(); wrap.classList.add('open'); inp.focus(); };
  document.addEventListener('click', (e) => { if(!wrap.contains(e.target) && inp.value.trim()==='') wrap.classList.remove('open'); });
  inp.addEventListener('input', debounce(() => callback(), 300));
};

setupSearch('#searchWrap', '#searchInput', '#searchTrigger', () => applyFilter());
setupSearch('#actSearchWrap', '#actSearchInput', '#actSearchTrigger', () => renderActs());

window.setMode = (mode) => {
  activeFilterMode = (activeFilterMode === mode) ? 'default' : mode;
  showAllMem = false;
  const btns = { 'bdh': '#btnQ_BDH', 'tt': '#btnQ_TT', 'pet': '#btnQ_Pet', 'cuu': '#btnQ_Cuu', 'ctv': '#btnQ_CTV' };
  for (const [k, v] of Object.entries(btns)) {
    const el = $(v);
    if(el) el.classList.toggle('active', activeFilterMode === k);
  }
  applyFilter();
}

const modal = $('#modal'), contactModal = $('#contactModal'), orgModal = $('#orgModal'), qrModal = $('#qrModal'), passModal = $('#passModal');
window.closeModal = (id) => $(`#${id}`).classList.remove('open');
$('#btnOpenContact').onclick = () => contactModal.classList.add('open');
$('#btnOrg').onclick = () => { buildTimeline(); orgModal.classList.add('open'); };
window.openQrModal = (e) => { e.stopPropagation(); qrModal.classList.add('open'); }

[modal, contactModal, orgModal, qrModal, passModal].forEach(m => {
  m.onclick = (e) => { if(e.target === m) m.classList.remove('open'); }
});

const roleRank = { 'truong nha':1, 'quan ly':2, 'giam linh':3, 'hoi truc':4, 'it':5 };
const getRank = (r) => roleRank[rmAccent(r)] || 99;
const isCuu = (r) => /\b(cuu|alumni|former)\b/i.test(rmAccent(r));
const isBDH = (r) => /\b(giam linh|truong nha|quan ly|hoi truc|it|i\.t)\b/i.test(rmAccent(r));
const isPet = (r) => /\b(pet|ctv|thu cung)\b/i.test(rmAccent(r));
const isTT = (r) => /\b(thuong truc|hang xom)\b/i.test(rmAccent(r));
const isCTV = (r) => /\b(ctv|cong tac vien|collaborator)\b/i.test(rmAccent(r));

function getGroup(role) {
  if (isBDH(role)) return 'bdh';
  if (isTT(role)) return 'tt';
  if (isCTV(role)) return 'ctv';
  if (isPet(role)) return 'pet';
  if (isCuu(role)) return 'cuu';
  return 'mem';
}

function parseMembers(data) {
  let raw = [];
  if(Array.isArray(data)){
    raw = data;
  } else {
    const wb = XLSX.read(data, {type:'array'});
    const ws = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(ws, {header:1, defval:''});
    const [h, ...rows] = json;
    const map = {};
    h.forEach((col, i) => {
      const k = rmAccent(col);
      if (k.includes('ten thanh') || k.includes('bon mang')) map.holy = i;
      else if (k.includes('nganh') || k.includes('major')) map.major = i;
      else if (k.includes('ten') && !k.includes('thanh')) map.name = i;
      else if (k.includes('chuc') || k.includes('role')) map.role = i;
      else if (k.includes('anh') || k.includes('avatar')) map.avatar = i;
      else if (k.includes('sinh') || k.includes('birth')) map.birth = i;
      else if (k.includes('nhap') || k.includes('join')) map.join = i;
      else if (k.includes('truong') || k.includes('school')) map.school = i;
      else if (k.includes('phone') || k.includes('sdt')) map.phone = i;
      else if (k.includes('fb') || k.includes('facebook')) map.fb = i;
      else if (k.includes('zalo')) map.zalo = i;
      else if (k.includes('bio') || k.includes('gioi thieu')) map.bio = i;
      else if (k.includes('email')) map.email = i;
      else if (k.includes('insta')) map.insta = i;
      else if (k.includes('locket')) map.locket = i;
      else if (k.includes('ghi chu') || k.includes('note')) map.note = i;
    });
    raw = rows.map(r => ({
      name: r[map.name], 
      role: String(r[map.role] || 'Thành viên'),
      avatarRaw: r[map.avatar], 
      holy: r[map.holy], birth: r[map.birth], join: r[map.join], school: r[map.school], major: r[map.major],
      phone: r[map.phone], fb: r[map.fb], zalo: r[map.zalo], bio: r[map.bio], email: r[map.email], insta: r[map.insta], locket: r[map.locket],
      note: r[map.note]
    })).filter(m => m.name);
  }

  MEMBERS = raw.map(m => {
    const url = normalizeImg(m.avatarRaw || m.avatar, FOLDER_MEM);
    return { 
      ...m, 
      avatar: url ? url : DEFAULT_AVATAR,
      group: getGroup(m.role) 
    };
  });
  
  MEMBERS.sort((a,b) => {
    const ga = a.group === 'bdh' ? 0 : 1;
    const gb = b.group === 'bdh' ? 0 : 1;
    if(ga !== gb) return ga - gb; 
    if(a.group === 'bdh') return getRank(a.role) - getRank(b.role); 
    return (parseInt(b.join)||0) - (parseInt(a.join)||0);
  });

  const hasCTV = MEMBERS.some(m => m.group === 'ctv');
  const btnCTV = document.getElementById('btnQ_CTV');
  if(btnCTV) btnCTV.style.display = hasCTV ? 'inline-block' : 'none';

  const hasTT = MEMBERS.some(m => m.group === 'tt');
  const btnTT = document.getElementById('btnQ_TT');
  if(btnTT) btnTT.style.display = hasTT ? 'inline-block' : 'none';

  updateContactInfo();
  renderAllMembersOnce();
  applyFilter();
}

function updateContactInfo() {
  const leader = MEMBERS.find(m => {
    const r = rmAccent(m.role);
    return r.includes('truong nha') || r.includes('leader');
  });
  const nameEl = document.getElementById('c-leader-name');
  const phoneEl = document.getElementById('c-leader-phone');
  if(leader) {
    if(nameEl) nameEl.textContent = leader.name;
    if(phoneEl) {
      const p = leader.phone || '';
      phoneEl.textContent = p ? p : 'Chưa cập nhật SĐT';
      phoneEl.href = p ? `tel:${p.replace(/\s/g,'')}` : '#';
    }
  } else {
    if(nameEl) nameEl.textContent = "Chưa có thông tin";
  }
}

function renderAllMembersOnce() {
  const container = $('#all-members-grid');
  container.innerHTML = MEMBERS.map((m, index) => {
    const isManager = rmAccent(m.role).includes('quan ly');
    const qrBtn = isManager ? `
      <div class="btn-qr" onclick="openQrModal(event)">
        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M3 3h6v6H3V3zm2 2v2h2V5H5zm8-2h6v6h-6V3zm2 2v2h2V5h-2zM3 13h6v6H3v-6zm2 2v2h2v-2H5zm13-2h3v2h-3v-2zm-3 2h2v2h-2v-2zm-3 2h3v2h-3v-2zm3 3h2v2h-2v-2zm-6-5h3v2H8v-2zm3 3h2v2h-2v-2z"></path></svg>
      </div>` : '';

    return `
    <div class="member-card" data-idx="${index}" data-name="${rmAccent(m.name)}" data-role="${rmAccent(m.role)}" data-group="${m.group}" onclick="openMemberModal(${index})">
      ${qrBtn}
      <div class="member-photo">
        <img src="${m.avatar}" loading="lazy" alt="${m.name}" 
             onerror="this.onerror=null;this.src='${DEFAULT_AVATAR}'">
      </div>
      <div class="member-info"><div class="m-name">${m.name}</div><div class="m-role">${m.role}</div></div>
    </div>
  `}).join('');
}

function getLimit() {
  const w = window.innerWidth;
  if (w < 600) return 6;
  if (w >= 1024) return 10;
  return 8;
}

function applyFilter() {
  const term = rmAccent($('#searchInput').value);
  const container = $('#all-members-grid');
  const items = container.children;
  const limit = getLimit();
  let visibleCount = 0, matchCount = 0;

  for (let i = 0; i < items.length; i++) {
    const el = items[i];
    const mName = el.getAttribute('data-name');
    const mRole = el.getAttribute('data-role');
    const mGroup = el.getAttribute('data-group');
    
    const matchSearch = !term || (mName + mRole).includes(term);
    
    let matchMode = false;
    if (activeFilterMode === 'default') {
      if (term) matchMode = true; 
      else matchMode = (mGroup === 'bdh' || mGroup === 'mem');
    } else {
      matchMode = (mGroup === activeFilterMode);
    }

    if (matchSearch && matchMode) {
      matchCount++;
      let shouldShow = true;
      if (!term && !showAllMem) {
        if (visibleCount >= limit) shouldShow = false;
      }
      if (shouldShow) { el.classList.remove('hidden-item'); visibleCount++; } 
      else { el.classList.add('hidden-item'); }
    } else {
      el.classList.add('hidden-item');
    }
  }

  const btnMore = $('#btnMore');
  if (!term && matchCount > limit) {
    btnMore.style.display = 'inline-flex';
    btnMore.textContent = showAllMem ? 'Thu gọn' : `Xem thêm (${matchCount - limit})`;
  } else {
    btnMore.style.display = 'none';
  }
}

$('#btnMore').onclick = () => { showAllMem = !showAllMem; applyFilter(); };
window.addEventListener('resize', debounce(() => { 
  if(activeFilterMode === 'default') applyFilter(); 
  renderActs();
}, 200));

window.toggleGallery = (e) => {
  if(e.target.classList.contains('gal-nav')) return; // Chặn click vào nút nav
  if(e.target.classList.contains('gal-btn')) return;
  const wrap = $('#gal-wrap');
  wrap.classList.toggle('is-expanded');
  if(!wrap.classList.contains('is-expanded')) {
    galIndex = 0;
    updateGalUI();
  }
}

window.openMemberModal = (index) => {
  const m = MEMBERS[index];
  if(!m) return;
  
  galImages = [m.avatar || DEFAULT_AVATAR];
  galIndex = 0;
  $('#gal-wrap').classList.remove('is-expanded'); 
  
  if(m.avatar && !m.avatar.startsWith('http')) {
    const lastDot = m.avatar.lastIndexOf('.');
    if(lastDot !== -1) {
      const base = m.avatar.substring(0, lastDot);
      const ext = m.avatar.substring(lastDot);
      const parts = base.split('/');
      const fileName = parts[parts.length - 1];
      const folderPath = base + '/'; 
      for(let i=1; i<=5; i++) {
        const img = new Image();
        const path = `${folderPath}${fileName}${i}${ext}`;
        img.src = encodeURI(path);
        img.onload = () => { galImages.push(img.src); updateGalUI(); };
      }
    }
  }

  updateGalUI();
  
  const noteDiv = $('#m-note-container');
  noteDiv.innerHTML = m.note ? `<div class="m-note">${m.note}</div>` : '';

  $('#m-name').innerText = m.name;
  $('#m-role').innerText = m.role;
  $('#m-holy').innerText = m.holy || '—';
  $('#m-birth').innerText = m.birth || '—';
  $('#m-school').innerText = m.school || '—';
  $('#m-major').innerText = m.major || '—';
  $('#m-join').innerText = m.join || '—';
  $('#m-bio').innerText = m.bio || '';
  
  const links = [
    {k:'fb', c:'facebook', t:'Facebook', l: m.fb},
    {k:'zalo', c:'zalo', t:'Zalo', l: m.zalo},
    {k:'insta', c:'instagram', t:'Instagram', l: m.insta},
    {k:'locket', c:'locket', t:'Locket', l: m.locket},
    {k:'phone', c:'phone', t:'Gọi điện', l: m.phone ? `tel:${m.phone}` : null},
    {k:'email', c:'email', t:'Email', l: m.email ? `mailto:${m.email}` : null}
  ];
  
  let linksHTML = links.filter(x => x.l).map(x => `<a href="${x.l}" target="_blank" class="c-btn ${x.c}">${x.t}</a>`).join('');

  const r = rmAccent(m.role);
  const isCollaborator = r.includes('ctv') || r.includes('cong tac vien') || r.includes('collaborator');
  
  if (isCollaborator) {
    let leaderLink = '#';
    const leader = MEMBERS.find(x => rmAccent(x.role).includes('truong nha'));
    if(leader) {
      if(leader.phone) leaderLink = `tel:${leader.phone}`;
      else if(leader.zalo) leaderLink = leader.zalo;
      else if(leader.fb) leaderLink = leader.fb;
    } else {
      leaderLink = "tel:0909831284";
    }
    linksHTML += `<a href="${leaderLink}" target="_blank" class="c-btn join-ctv">Tham gia CTV</a>`;
  }

  $('#m-contact-btns').innerHTML = linksHTML;
  modal.classList.add('open');
}

function updateGalUI() {
  $('#m-avatar').src = galImages[galIndex];
  const wrap = $('#gal-wrap');
  
  // Logic kiểm tra số lượng ảnh để hiện nút
  if(galImages.length > 1) {
    wrap.classList.add('has-multiple');
  } else {
    wrap.classList.remove('has-multiple');
  }
}

// --- UPDATED GALLERY NAVIGATION ---
window.galNext = (e) => {
  if(e) e.stopPropagation(); 
  if(galImages.length <= 1) return;
  galIndex = (galIndex + 1) % galImages.length;
  updateGalUI();
}

window.galPrev = (e) => {
  if(e) e.stopPropagation();
  if(galImages.length <= 1) return;
  galIndex = (galIndex - 1 + galImages.length) % galImages.length;
  updateGalUI();
}

let touchStartX = 0;
const galWrap = $('#gal-wrap');
galWrap.addEventListener('touchstart', e => touchStartX = e.changedTouches[0].screenX);
galWrap.addEventListener('touchend', e => {
  if(!galWrap.classList.contains('is-expanded')) return;
  const touchEndX = e.changedTouches[0].screenX;
  if (touchEndX < touchStartX - 50) galNext();
  if (touchEndX > touchStartX + 50) galPrev();
});

function parseActs(data) {
  if(Array.isArray(data)) {
    ACTS = data.map(a => ({...a, img: normalizeImg(a.img, FOLDER_ACT)}));
  } else {
    const wb = XLSX.read(data, {type:'array'});
    const ws = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(ws, {header:1, defval:''});
    const [h, ...rows] = json;
    const map = {};
    h.forEach((col, i) => {
      const k = rmAccent(col);
      if(k.includes('tieu de')||k.includes('ten')) map.title=i;
      else if(k.includes('tom tat')||k.includes('mo ta')) map.sum=i;
      else if(k.includes('anh')||k.includes('img')) map.img=i;
      else if(k.includes('link')||k.includes('url')) map.link=i;
      else if(k.includes('hot')||k.includes('noi bat')) map.hot=i;
      else if(k.includes('nam')) map.year=i;
      else if(k.includes('tag')||k.includes('chu de')) map.tag=i;
      else if(k.includes('cta')||k.includes('nut')) map.cta=i;
      else if(k.includes('phu trach')) map.owner=i;
      else if(k.includes('pass')||k.includes('mat khau')) map.pass=i;
    });

    ACTS = rows.map(r => {
      let hotVal = 999;
      const rawHot = String(r[map.hot] || '').toLowerCase().trim();
      const num = parseInt(rawHot);
      if (!isNaN(num) && num > 0) hotVal = num; else if (rawHot.includes('x')) hotVal = 1;
      return {
        title: r[map.title], sum: r[map.sum], img: normalizeImg(r[map.img], FOLDER_ACT),
        tag: r[map.tag], year: r[map.year], owner: r[map.owner], link: r[map.link] || '#',
        hotVal: hotVal, cta: r[map.cta] || 'Xem chi tiết',
        pass: String(r[map.pass] || '').trim()
      };
    }).filter(x => x.title);
    ACTS.sort((a,b) => a.hotVal - b.hotVal);
  }
  const tags = [...new Set(ACTS.map(a => a.tag).filter(Boolean))].sort();
  $('#actFilters').innerHTML = tags.map(t => `<button class="q-btn" onclick="filterAct('${t}')">${t}</button>`).join('');
  renderActs();
}

window.filterAct = (tag) => {
  activeActTag = (activeActTag === tag) ? null : tag;
  $$('#actFilters .q-btn').forEach(btn => btn.classList.toggle('active', btn.innerText === activeActTag));
  showAllActs = false;
  renderActs();
}

function getActLimit() {
  const w = window.innerWidth;
  if (w < 600) return 3;
  if (w < 1024) return 4;
  return 6;
}

function renderActs() {
  const term = rmAccent($('#actSearchInput').value);
  let list = ACTS;
  if (term) list = list.filter(a => rmAccent(a.title + a.tag + a.year).includes(term));
  if (activeActTag) list = list.filter(a => a.tag === activeActTag);
  
  const limit = getActLimit();
  const displayList = showAllActs ? list : list.slice(0, limit);
  
  $('#actGrid').innerHTML = displayList.map(a => {
    let btnHtml = '';
    const safeLink = a.link.replace(/'/g, "\\'"); 
    const safePass = a.pass.replace(/'/g, "\\'"); 

    if(a.pass && a.pass !== "") {
        btnHtml = `<button class="act-btn" onclick="checkActPass('${safeLink}', '${safePass}')">${a.cta}</button>`;
    } else {
        btnHtml = `<a href="${a.link}" target="_blank" class="act-btn">${a.cta}</a>`;
    }

    return `
    <div class="act-card">
      <div class="act-bg"><img src="${a.img}" loading="lazy" decoding="async" onerror="this.src='image/logo.jpg'"></div>
      ${a.hotVal < 999 ? '<div class="ribbon">Nổi bật</div>' : ''}
      <div class="act-content">
        <h3 class="act-title">${a.title}</h3>
        <div class="act-tags">
          ${a.tag ? `<span class="act-chip">${a.tag}</span>` : ''}
          ${a.year ? `<span class="act-chip">${a.year}</span>` : ''}
          ${a.owner ? `<span class="act-chip">${a.owner}</span>` : ''}
        </div>
        <p class="act-sum">${a.sum}</p>
        ${btnHtml}
      </div>
    </div>
  `}).join('');
  
  const btnMore = $('#btnActMore');
  if (list.length > limit) { 
    btnMore.style.display = 'inline-flex'; 
    btnMore.textContent = showAllActs ? 'Thu gọn' : `Xem thêm (${list.length - limit})`; 
  } else { 
    btnMore.style.display = 'none'; 
  }
}

// --- LOGIC XỬ LÝ MODAL MẬT KHẨU ---
let pendingLink = '', pendingPass = '';
const passInp = $('#userPassInput');
const passErr = $('#passError');

window.checkActPass = (link, truePass) => {
  pendingLink = link;
  pendingPass = truePass;
  // Reset trạng thái
  passInp.value = '';
  passInp.classList.remove('error');
  passErr.style.display = 'none';
  // Mở modal
  $('#passModal').classList.add('open');
  setTimeout(() => passInp.focus(), 100);
};

window.confirmPass = () => {
  if (passInp.value.trim() === pendingPass) {
    window.open(pendingLink, '_blank');
    closeModal('passModal');
  } else {
    // Hiệu ứng lỗi
    passInp.classList.add('error');
    passErr.style.display = 'flex';
    passInp.focus();
    setTimeout(() => passInp.classList.remove('error'), 500);
  }
};

passInp.addEventListener('keyup', (e) => {
  if (e.key === 'Enter') confirmPass();
});

$('#btnActMore').onclick = () => { showAllActs = !showAllActs; renderActs(); };
$('#btnLoad').onclick = async () => { const f = $('#excelFile').files[0]; if(f){ const b=await f.arrayBuffer(); parseMembers(b); } };

function buildTimeline(){
  const byYear = new Map();
  const sorted = [...MEMBERS].sort((a,b)=> parseInt(a.join||0) - parseInt(b.join||0));
  sorted.forEach((m, idx) => {
    const r = rmAccent(m.role);
    const allow = r.includes('cuu') || r.includes('thanh vien') || r.includes('truong nha') || r.includes('quan ly') || r.includes('giam linh') || r.includes('hoi truc');
    if(allow) {
      const y = m.join || '—';
      if(!byYear.has(y)) byYear.set(y, []);
      const originalIdx = MEMBERS.indexOf(m); 
      byYear.get(y).push({ ...m, oIdx: originalIdx });
    }
  });
  let html = '';
  byYear.forEach((arr, y)=>{
    html += `<div style="margin-bottom:24px"><div style="color:var(--brand);font-weight:800;margin-bottom:8px;font-size:1.1rem">Năm ${y}</div><div style="display:flex;flex-wrap:wrap;gap:8px">`;
    arr.forEach(m => { html += `<div class="chip" onclick="closeModal('orgModal');openMemberModal(${m.oIdx})">${m.name} - ${m.role}</div>`; });
    html += `</div></div>`;
  });
  $('#orgBody').innerHTML = html;
}

const PRE_DATA = [
  { name: "Vui lòng tải File", role: "Mất Kết Nối Máy Chủ",email: "1026cnh@gmail.com", instagram: "howl_cnh"}
  ];

const PRE_DATA_ACTS = [
  { title: "Mất Kết Nối Máy Chủ", sum: "Dữ liệu chưa tải được. Nếu dùng máy tính, hãy chọn file Excel thủ công.", tag: "Error", year: "", img: "banner.jpg", link: "#", hotVal: 1, cta: "Thử lại", pass: "" },
];

(async () => {
  try { 
    const res = await fetch('thanhvien.xlsx'); 
    if(res.ok) { const buf = await res.arrayBuffer(); parseMembers(buf); $('#drop').style.display = 'none'; } 
    else parseMembers(PRE_DATA); 
  } catch(e) { console.log('PC Mode: Auto-fetch blocked by CORS'); parseMembers(PRE_DATA); }

  try { 
    const resA = await fetch('hoatdong.xlsx'); 
    if(resA.ok) { const bufA = await resA.arrayBuffer(); parseActs(bufA); } 
    else parseActs(PRE_DATA_ACTS); 
  } catch(e) { parseActs(PRE_DATA_ACTS); }
})();

const slides = $$('.slide'), dots = $('#dots');
let cur = 0;
slides.forEach((_,i)=>{ const d=document.createElement('div'); d.className=`dot ${i===0?'active':''}`; d.onclick=()=>setSlide(i); dots.appendChild(d); });
function setSlide(i){ 
  slides.forEach(s=>s.classList.remove('active')); 
  $$('.dot').forEach(d=>d.classList.remove('active')); 
  slides[i].classList.add('active'); 
  $$('.dot')[i].classList.add('active'); 
  cur=i; 
}
setInterval(()=>setSlide((cur+1)%slides.length), 5000);
$('#year').innerText = new Date().getFullYear();
</script>
</body>
</html>
